import { useState, useEffect } from "react";

const rawSchedule = [
  "2025-04-14|ğŸŠ 1.6km ká»¹ thuáº­t + core 15â€™ (~50')",
  "2025-04-15|ğŸƒ Tempo 8km @5:25/km (~45')",
  "2025-04-16|ğŸŠ 2.0km endurance (~55')",
  "2025-04-17|ğŸš´ 1h15 Z2 + intervals (~75')",
  "2025-04-18|ğŸŠ 1.5km nháº¹ + pick-up (~45')",
  "2025-04-19|ğŸš´ 75â€“85km + ğŸƒ 5km brick (~3h30')",
  "2025-04-20|ğŸƒ Long run 16km @6:00/km (~1h40')",

  "2025-04-21|ğŸŠ 1.6km ká»¹ thuáº­t + core 20â€™ (~55')",
  "2025-04-22|ğŸƒ 6Ã—800m intervals (~50')",
  "2025-04-23|ğŸŠ 2.2km steady pace (~60')",
  "2025-04-24|ğŸš´ 1h20 Z2 + sweet spot (~80')",
  "2025-04-25|ğŸŠ 1.4km + sprint drill (~40')",
  "2025-04-26|ğŸŠ + ğŸš´ + ğŸƒ race sim (~4hâ€“4h30')",
  "2025-04-27|âŒ Nghá»‰ hoÃ n toÃ n",

  "2025-04-28|ğŸŠ 1.2km nháº¹ + giÃ£n cÆ¡ (~40')",
  "2025-04-29|ğŸƒ Tempo 6km @pace Ä‘ua (~35')",
  "2025-04-30|ğŸŠ 1.5km nháº¹ + drill (~45')",
  "2025-05-01|ğŸš´ 1h Z2 + burst (~60')",
  "2025-05-02|ğŸŠ 1.5km steady pace (~45')",
  "2025-05-03|ğŸš´ 50km + ğŸƒ 5km brick (~2h30')",
  "2025-05-04|ğŸƒ Easy run 6â€“8km (~45')",

  "2025-05-05|ğŸŠ 1.2km nháº¹ ká»¹ thuáº­t (~35')",
  "2025-05-06|ğŸƒ 5km nháº¹ + strides (~35')",
  "2025-05-07|ğŸŠ 800m + 4Ã—50m pick-up (~30')",
  "2025-05-08|ğŸš´ 45' nháº¹ Z2 (~45')",
  "2025-05-09|âŒ Nghá»‰ hoÃ n toÃ n",
  "2025-05-10|ğŸ—¿ RACE DAY â€“ Ironman 70.3",
  "2025-05-11|ğŸ›Œ Nghá»‰ hoáº·c Ä‘i bá»™ nháº¹ (~20')"
];

function getCountdownParts() {
  const now = new Date();
  const raceDay = new Date("2025-05-10T00:00:00");
  const diff = raceDay.getTime() - now.getTime();

  if (diff <= 0) {
    return { finished: true };
  }

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
  const minutes = Math.floor((diff / (1000 * 60)) % 60);
  const seconds = Math.floor((diff / 1000) % 60);

  return { days, hours, minutes, seconds, finished: false };
}

function getColorForWorkout(workout) {
  if (workout.includes("race sim") || workout.includes("brick")) return "bg-gradient-to-r from-blue-200 via-yellow-200 to-green-200 text-green-900";
  if (workout.includes("âŒ") || workout.includes("ğŸ›Œ")) return "bg-gray-100 text-gray-500";
  if (workout.includes("RACE DAY")) return "bg-red-600 text-white";
  if (workout.includes("ğŸŠ")) return "bg-blue-50 text-blue-800";
  if (workout.includes("ğŸš´")) return "bg-yellow-50 text-yellow-800";
  if (workout.includes("ğŸƒ")) return "bg-green-50 text-green-800";
  return "";
}

function getTodayAndUpcomingSessions(schedule) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const parsedSchedule = schedule.map((line) => {
    const [dateStr, workout] = line.split("|");
    const date = new Date(dateStr);
    return { date, workout };
  });

  const todayItem = parsedSchedule.find((item) => item.date.getTime() === today.getTime());
  const futureItems = parsedSchedule.filter((item) => item.date >= today);

  return { todayItem, futureItems };
}

export default function IronmanTracker() {
  const [todaySession, setTodaySession] = useState("");
  const [todayColor, setTodayColor] = useState("");
  const [upcomingSessions, setUpcomingSessions] = useState([]);
  const [countdown, setCountdown] = useState(getCountdownParts());

  useEffect(() => {
    const interval = setInterval(() => {
      setCountdown(getCountdownParts());
    }, 1000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    const { todayItem, futureItems } = getTodayAndUpcomingSessions(rawSchedule);
    if (todayItem) {
      setTodaySession(`(${todayItem.date.getDate()}/${todayItem.date.getMonth() + 1}) â€“ ${todayItem.workout}`);
      setTodayColor(getColorForWorkout(todayItem.workout));
    } else {
      setTodaySession("KhÃ´ng cÃ³ lá»‹ch táº­p cho hÃ´m nay.");
      setTodayColor("bg-gray-50 text-gray-400");
    }
    setUpcomingSessions(futureItems);
  }, []);

  return (
    <div className="bg-[#f2f2f7] min-h-screen px-4 py-6 font-sans text-gray-800">
      <div className="max-w-xl mx-auto space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">ğŸ Road to IM 70.3 ÄÃ  Náºµng</h1>
          <div className="rounded-3xl px-6 py-4 bg-red-500 text-white text-3xl font-semibold tracking-widest shadow-md">
            {countdown.finished ? (
              <span>ğŸ”¥ CÃ³ finish khÃ´ng?</span>
            ) : (
              <span>
                {String(countdown.days).padStart(2, '0')}d :
                {String(countdown.hours).padStart(2, '0')}h :
                {String(countdown.minutes).padStart(2, '0')}m :
                {String(countdown.seconds).padStart(2, '0')}s
              </span>
            )}
          </div>
        </div>

        <div className={`${todayColor} rounded-2xl p-5 shadow-md`}> 
          <h2 className="text-lg font-semibold text-gray-900 mb-2">HÃ´m nay táº­p gÃ¬?</h2>
          <p className="text-base font-medium leading-relaxed">{todaySession}</p>
        </div>

        <div className="bg-white rounded-2xl shadow-md p-4">
          <h2 className="text-lg font-semibold text-gray-900 mb-3">ğŸ“… Lá»‹ch táº­p sáº¯p tá»›i</h2>
          <div className="divide-y divide-gray-200">
            {upcomingSessions.map((item, index) => (
              <div
                key={index}
                className={`py-2 px-3 rounded-xl my-1 ${getColorForWorkout(item.workout)} ${item.date.getTime() === new Date().setHours(0, 0, 0, 0) ? 'font-bold border border-black' : ''}`}
              >
                <div className="text-sm font-medium">{`${item.date.getDate()}/${item.date.getMonth() + 1}`}</div>
                <div className="text-sm whitespace-pre-line">{item.workout}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
